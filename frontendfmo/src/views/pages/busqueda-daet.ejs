<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('../partials/head') %>
    <title>B√∫squeda DAET</title>
    <style>
        /* --- ESTILOS COMPACTOS (Paper Form) --- */
        .paper-form {
            background-color: #fff;
            border: 2px solid #000;
            color: #000;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            max-width: 550px; /* Ancho ajustado igual que en daet.ejs */
            margin: 0 auto;
        }
        
        .cell-border {
            border: 1px solid #000;
            padding: 2px 5px;
            display: flex;
            align-items: center;
        }
        .cell-block { display: block; }
        .input-line {
            border: none;
            background: transparent;
            width: 100%;
            font-weight: bold;
            color: #000080;
            height: 20px;
            font-size: 13px;
            padding: 0 5px;
        }
        .input-line:focus { outline: none; }
        .label-text {
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .form-check { margin-bottom: 0; margin-right: 10px; }
        .form-check-input { border: 1px solid #000; width: 14px; height: 14px; margin-top: 2px; margin-right: 5px; }
        .row-compact { --bs-gutter-x: 0; }
        .header-title { letter-spacing: 2px; font-weight: 900; text-decoration: underline; }
        
        /* Clase para ocultar secciones visualmente si no aplican (opcional) */
        .hidden-section { display: none; }
    </style>
</head>
<body>
    <div class="wrapper">
        <%- include('../partials/sidebar') %>
        <div id="content" class="w-100 bg-light p-4">
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <a href="/busqueda" class="btn btn-outline-secondary btn-sm">‚¨Ö Volver al Men√∫</a>
                <h5 class="m-0 fw-bold">üöö Historial de Entregas al DAET</h5>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body">
                    
                    <div class="row g-2 align-items-center mb-4">
                        <div class="col-md-3">
                            <label class="form-label small fw-bold">Filtrar por:</label>
                            <select class="form-select" id="filtroSelect" onchange="cambiarFiltro()">
                                <option value="todo">Listar Todo</option>
                                <option value="fmoSerial">FMO / Serial (Individual)</option>
                                <option value="fmoEquipo">FMO Equipo (Lote)</option>
                                <option value="fecha">Fecha</option>
                            </select>
                        </div>

                        <div class="col-md-7" id="containerInputSerial" style="display: none;">
                            <label class="form-label small fw-bold">Ingrese Serial del Equipo:</label>
                            <input type="text" class="form-control" id="inputBusquedaSerial" placeholder="Ej: XYZ-123...">
                        </div>

                        <div class="col-md-7" id="containerInputLote" style="display: none;">
                            <label class="form-label small fw-bold">Ingrese FMO del Lote/Equipo:</label>
                            <input type="text" class="form-control" id="inputBusquedaLote" placeholder="Ej: LOTE-GEN-2025...">
                        </div>

                        <div class="col-md-7" id="containerInputFecha" style="display: none;">
                            <label class="form-label small fw-bold">Seleccione Fecha:</label>
                            <input type="date" class="form-control" id="inputBusquedaFecha">
                        </div>

                        <div class="col-md-7" id="containerVacio"></div>

                        <div class="col-md-2 text-end">
                            <label class="form-label d-block">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="buscarDaet()">üîç Buscar</button>
                        </div>
                    </div>

                    <div class="table-responsive table-scroll-wrapper">
                        <table class="table table-hover table-bordered align-middle">
                            <thead class="table-light text-center">
                                <tr>
                                    <th width="5%">#</th>
                                    <th>Solicitud DAET</th>
                                    <th>FMO EQUIPO</th>
                                    <th>FMO Serial</th>
                                    <th>Actividad</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaResultados" class="text-center">
                                <tr><td colspan="7" class="text-muted">Seleccione un filtro y busque para ver resultados.</td></tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="modalVerDaet" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light py-2">
                    <h6 class="modal-title fw-bold">üìÑ Detalle de Entrega</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-secondary bg-opacity-10">
                    
                    <div class="paper-form container p-0" id="formDaetModal">
                        
                        <div class="row row-compact">
                            <div class="col-12 text-center cell-border justify-content-between bg-light p-2">
                                <div style="width: 30px;"></div> <span class="header-title">ENTREGAS AL DAET</span>
                                <span style="font-size: 20px;">üì¶</span> </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">FECHA:</span>
                                <input type="text" class="input-line" id="modal_fecha" readonly style="max-width: 150px;">
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">SOLICITUD DAET.:</span>
                                <input type="text" class="input-line" id="modal_solicitudDAET" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">SOLICITUD S.T.:</span>
                                <input type="text" class="input-line" id="modal_solicitudST" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">ANALISTA:</span>
                                <input type="text" class="input-line" id="modal_analista" readonly>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border justify-content-center bg-light">
                                <span class="label-text">ACTIVIDAD:</span>
                            </div>
                            <div class="col-12 cell-border justify-content-center">
                                <div class="form-check form-check-inline me-5">
                                    <input class="form-check-input modal-radio" type="radio" name="actividad_modal" id="modal_act_reemplazo" disabled>
                                    <label class="label-text">REEMPLAZO</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input modal-radio" type="radio" name="actividad_modal" id="modal_act_entrega" disabled>
                                    <label class="label-text">ENTREGA</label>
                                </div>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-3">ESTADO:</span>
                                <div class="form-check form-check-inline me-4">
                                    <input class="form-check-input modal-radio" type="radio" name="estado_modal" id="modal_est_bueno" disabled>
                                    <label class="label-text">BUENO</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input modal-radio" type="radio" name="estado_modal" id="modal_est_danado" disabled>
                                    <label class="label-text">DA√ëADO</label>
                                </div>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">EQUIPO:</span>
                                <input type="text" class="input-line" id="modal_nombreEquipo" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">COMPONENTES:</span>
                                <input type="text" class="input-line" id="modal_componentesTexto" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">PERIF√âRICOS:</span>
                                <input type="text" class="input-line" id="modal_perifericosTexto" readonly>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border">
                                <span class="label-text me-2">FMO/SERIAL:</span>
                                <input type="text" class="input-line" id="modal_fmoSerial" readonly>
                            </div>
                        </div>

                        <div id="wrapperEntregaCpu">
                            <div class="row row-compact">
                                <div class="col-12 cell-border bg-light">
                                    <span class="label-text">ENTREGA DE CPU (Detalles):</span>
                                </div>
                            </div>
                            
                            <div class="row row-compact">
                                <div class="col-6 cell-border cell-block">
                                    <div class="form-check mb-1">
                                        <input class="form-check-input modal-cpu-check" type="checkbox" id="chk_disco" disabled>
                                        <label class="label-text">DISCO DURO</label>
                                    </div>
                                    <div class="d-flex align-items-center mb-1">
                                        <input class="form-check-input modal-cpu-check" type="checkbox" id="chk_ram" disabled>
                                        <label class="label-text me-1">MEMORIAS RAM</label>
                                        <span style="font-size:10px;">--</span>
                                        <span class="label-text ms-1 me-1">CANT:</span>
                                        <input type="text" class="input-line text-center" id="modal_cantRam" style="width: 30px;" readonly>
                                    </div>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input modal-cpu-check" type="checkbox" id="chk_madre" disabled>
                                        <label class="label-text">TARJETA MADRE</label>
                                    </div>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input modal-cpu-check" type="checkbox" id="chk_procesador" disabled>
                                        <label class="label-text">PROCESADOR</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input modal-cpu-check" type="checkbox" id="chk_fan" disabled>
                                        <label class="label-text">FAN COOLER</label>
                                    </div>
                                </div>

                                <div class="col-6 cell-border cell-block">
                                    <div class="form-check mb-1">
                                        <input class="form-check-input modal-cpu-check" type="checkbox" id="chk_video" disabled>
                                        <label class="label-text">TARJETA DE VIDEO</label>
                                    </div>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input modal-cpu-check" type="checkbox" id="chk_fuente" disabled>
                                        <label class="label-text">FUENTE DE PODER</label>
                                    </div>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input modal-cpu-check" type="checkbox" id="chk_pila" disabled>
                                        <label class="label-text">PILA</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input modal-cpu-check" type="checkbox" id="chk_red" disabled>
                                        <label class="label-text">TARJETA DE RED</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border bg-light justify-content-center">
                                <span class="label-text">SE RECIBE REEMPLAZO</span>
                            </div>
                        </div>
                        <div class="row row-compact">
                            <div class="col-12 cell-border align-items-center">
                                <div class="form-check form-check-inline ms-2">
                                    <input class="form-check-input modal-radio" type="radio" name="reemplazo_modal" id="modal_reemplazoSi" disabled>
                                    <label class="label-text">SI</label>
                                </div>
                                <div class="form-check form-check-inline me-4">
                                    <input class="form-check-input modal-radio" type="radio" name="reemplazo_modal" id="modal_reemplazoNo" disabled>
                                    <label class="label-text">NO</label>
                                </div>
                                <span class="label-text me-2 border-start border-dark ps-2">IDENTIFIQUE:</span>
                                <input type="text" class="input-line" id="modal_identifique" readonly>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-12 cell-border cell-block">
                                <span class="label-text">(OBSERVACI√ìN):</span>
                                <textarea class="input-line" rows="2" id="modal_observacion" style="resize: none;" readonly></textarea>
                            </div>
                        </div>

                        <div class="row row-compact">
                            <div class="col-8 cell-border" style="height: 50px;">
                                <span class="label-text">RECIBIDO POR:</span>
                                <input type="text" class="input-line" id="modal_recibidoPor" readonly>
                            </div>
                            <div class="col-4 cell-border" style="height: 50px;">
                                <span class="label-text">FICHA:</span>
                                <input type="text" class="input-line" id="modal_fichaRecibido" readonly>
                            </div>
                        </div>

                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-danger" onclick="generarPDFRecibo()">
                        üñ®Ô∏è Descargar PDF
                </button>
                </div>
                   
            </div>
        </div>
    </div>

    <script src="/js/bootstrap/bootstrap.bundle.min.js"></script>

    <script src="/js/html2pdf.bundle.min.js"></script>

    <script src="/js/pdf.js"></script>

    <script>
        // --- 1. L√ìGICA DE FILTROS ---
        function cambiarFiltro() {
            const filtro = document.getElementById('filtroSelect').value;
            const divSerial = document.getElementById('containerInputSerial');
            const divLote = document.getElementById('containerInputLote');
            const divFecha = document.getElementById('containerInputFecha');
            const divVacio = document.getElementById('containerVacio');

            divSerial.style.display = 'none';
            divLote.style.display = 'none';
            divFecha.style.display = 'none';
            divVacio.style.display = 'none';

            if (filtro === 'fmoSerial') divSerial.style.display = 'block';
            else if (filtro === 'fmoEquipo') divLote.style.display = 'block';
            else if (filtro === 'fecha') divFecha.style.display = 'block';
            else divVacio.style.display = 'block'; 
        }

        // --- 2. L√ìGICA DE B√öSQUEDA ---
        async function buscarDaet() {
            const filtro = document.getElementById('filtroSelect').value;
            let url = 'http://127.0.0.1:8081/api/buscarEntregasAlDaet'; 

            if (filtro === 'fmoSerial') {
                const val = document.getElementById('inputBusquedaSerial').value;
                if(!val) return alert("Ingrese el Serial");
                url = `http://127.0.0.1:8081/api/buscarEntregasAlDaet/fmoSerial/${val}`;
            }
            else if (filtro === 'fmoEquipo') {
                const val = document.getElementById('inputBusquedaLote').value;
                if(!val) return alert("Ingrese el FMO Equipo");
                url = `http://127.0.0.1:8081/api/buscarEntregasAlDaet/fmoEquipo/${val}`; 
            }
            else if (filtro === 'fecha') {
                const val = document.getElementById('inputBusquedaFecha').value;
                if(!val) return alert("Seleccione Fecha");
                url = `http://127.0.0.1:8081/api/buscarEntregasAlDaet/fecha/${val}`;
            }

            const tbody = document.getElementById('tablaResultados');
            tbody.innerHTML = '<tr><td colspan="7">Cargando...</td></tr>';

            try {
                const response = await fetch(url);
                if(!response.ok) throw new Error("Sin resultados o error de conexi√≥n.");
                const data = await response.json();
                renderizarTabla(data);
            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="7" class="text-danger">${error.message}</td></tr>`;
            }
        }

        function renderizarTabla(data) {
            const tbody = document.getElementById('tablaResultados');
            tbody.innerHTML = '';
            const lista = Array.isArray(data) ? data : [data];

            if(lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No hay registros.</td></tr>';
                return;
            }

            lista.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold">${index + 1}</td>
                    <td>${item.solicitudDAET || "N/A"}</td>
                    <td class="text-primary fw-bold">${item.fmoEquipoLote || "N/A"}</td>
                    <td>${item.fmoSerial || "S/N"}</td>
                    <td><span class="badge bg-secondary">${item.actividad}</span></td>
                    <td>${item.fecha}</td>
                    <td>
                        <button class="btn btn-sm btn-info text-white" onclick='abrirModalVer(${JSON.stringify(item)})'>
                            üëÅÔ∏è Ver
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 3. L√ìGICA DE VISUALIZACI√ìN ---
        function abrirModalVer(data) {
            // A. Datos Generales
            setVal('modal_fecha', data.fecha);
            setVal('modal_solicitudDAET', data.solicitudDAET);
            setVal('modal_solicitudST', data.solicitudST);
            setVal('modal_analista', data.asignadoA); // Analista es el asignado
            
            
            // B. Mapeo Inteligente de TIPO (Equipo / Componente / Perif√©rico)
            setVal('modal_nombreEquipo', "");
            setVal('modal_componentesTexto', "");
            setVal('modal_perifericosTexto', "");
            
            // Si el nombre del perif√©rico base es "CPU", "LAPTOP", etc., va en EQUIPO
            const tipo = (data.tipoPeriferico || "").toUpperCase();
            if (tipo.includes("CPU") || tipo.includes("LAPTOP") || tipo.includes("EQUIPO")) {
                setVal('modal_nombreEquipo', data.fmoEquipoLote || data.fmoSerial); // Usamos lote o serial como nombre ref
            } else if (data.componenteUnico && data.componenteUnico.length > 0) {
                // Es un componente suelto
                const unico = data.componenteUnico[0];
                setVal('modal_componentesTexto', unico.nombreComponente + (unico.cantidad > 1 ? ` (${unico.cantidad})` : ""));
            } else if (tipo) {
                // Es un perif√©rico suelto (Monitor, etc.)
                setVal('modal_perifericosTexto', tipo);
            }

            setVal('modal_fmoSerial', data.fmoSerial);
            setVal('modal_observacion', data.observacion);
            setVal('modal_identifique', data.identifique);
            setVal('modal_recibidoPor', data.recibidoPor);
            setVal('modal_fichaRecibido', data.ficha);
            

            // C. Radios Actividad / Estado
            document.querySelectorAll('.modal-radio').forEach(r => r.checked = false);
            if(data.actividad === 'Reemplazo') document.getElementById('modal_act_reemplazo').checked = true;
            else document.getElementById('modal_act_entrega').checked = true;

            if(data.estado === 'Bueno') document.getElementById('modal_est_bueno').checked = true;
            else document.getElementById('modal_est_danado').checked = true;

            // D. Radios Reemplazo (Abajo)
            if(data.identifique && data.identifique.length > 0 && data.identifique !== "N/A") {
                document.getElementById('modal_reemplazoSi').checked = true;
            } else {
                document.getElementById('modal_reemplazoNo').checked = true;
            }

            // E. Detalles de CPU (Checkboxes)
            document.querySelectorAll('.modal-cpu-check').forEach(c => c.checked = false);
            setVal('modal_cantRam', "");

            if(data.componentesInternos && data.componentesInternos.length > 0) {
                data.componentesInternos.forEach(comp => {
                    const nombre = (comp.nombreComponente || "").toUpperCase();
                    
                    if(nombre.includes("DISCO")) document.getElementById('chk_disco').checked = true;
                    if(nombre.includes("RAM") || nombre.includes("MEMORIA")) {
                        document.getElementById('chk_ram').checked = true;
                        setVal('modal_cantRam', comp.cantidad);
                    }
                    if(nombre.includes("MADRE")) document.getElementById('chk_madre').checked = true;
                    if(nombre.includes("PROCESADOR")) document.getElementById('chk_procesador').checked = true;
                    if(nombre.includes("FAN") || nombre.includes("COOLER")) document.getElementById('chk_fan').checked = true;
                    if(nombre.includes("VIDEO")) document.getElementById('chk_video').checked = true;
                    if(nombre.includes("FUENTE")) document.getElementById('chk_fuente').checked = true;
                    if(nombre.includes("PILA")) document.getElementById('chk_pila').checked = true;
                    if(nombre.includes("RED")) document.getElementById('chk_red').checked = true;
                });
            }

            const myModal = new bootstrap.Modal(document.getElementById('modalVerDaet'));
            myModal.show();
        }

        function setVal(id, val) {
            const el = document.getElementById(id);
            if(el) el.value = val || "";
        }
    </script>
</body>
</html>