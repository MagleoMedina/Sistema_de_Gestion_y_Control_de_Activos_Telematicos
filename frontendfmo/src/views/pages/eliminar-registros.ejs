<!DOCTYPE html>
<html lang="es">

<head>
    <%- include('../partials/head') %>
    <title>Eliminar Registros</title>
    <style>
        /* Estilos necesarios para los templates de papel dentro del modal */
        .paper-form {
            background-color: #fff;
            border: 2px solid #000;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            width: 100%;
            margin: 0 auto;
        }
        .cell-border { border: 1px solid #000; padding: 2px 5px; display: flex; align-items: center; }
        .cell-block { display: block; }
        .input-line { border: none; background: transparent; width: 100%; font-weight: bold; color: #000080; }
        .label-text { font-weight: bold; font-size: 0.75rem; text-transform: uppercase; }
        .row-compact { --bs-gutter-x: 0; }
        .tag-badge { background-color: #000080; color: white; padding: 1px 3px; border-radius: 4px; margin-right: 4px; font-size: 10px; }
        
        /* Ocultar secciones de templates por defecto */
        .template-section { display: none; }
    </style>
</head>

<body>
    <div class="wrapper">
        <%- include('../partials/sidebar') %>

        <div id="content" class="w-100 bg-light p-4">
            
            <h4 class="mb-4 fw-bold text-danger">üóëÔ∏è Gesti√≥n y Eliminaci√≥n de Registros</h4>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <div class="row g-3 align-items-end">
                        
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Tipo de Registro:</label>
                            <select class="form-select" id="selTipo">
                                <option value="equipos">üñ•Ô∏è Recibo de Equipos</option>
                                <option value="perifericos">‚å®Ô∏è Recibo de Perif√©ricos</option>
                                <option value="daet">üöö Entrega al DAET</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Buscar por (FMO, Serial, Solicitud):</label>
                            <input type="text" class="form-control" id="inputBusqueda" placeholder="Ej: 119000, Solicitud ST...">
                        </div>

                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="buscarRegistros()">
                                üîç Buscar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light text-center">
                                <tr>
                                    <th>#</th>
                                    <th>Identificador</th>
                                    <th>Fecha</th>
                                    <th>Usuario / Responsable</th>
                                    <th>Estatus</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaResultados" class="text-center">
                                <tr>
                                    <td colspan="6" class="text-muted py-4">Utilice el buscador para encontrar registros.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="modalVerDetalle" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl"> <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title fw-bold">üìÑ Vista Previa del Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <div id="view_equipos" class="template-section">
                        <%- include('../partials/forms/template-equipos') %>
                    </div>

                    <div id="view_perifericos" class="template-section">
                        <%- include('../partials/forms/template-perifericos') %>
                    </div>

                    <div id="view_daet" class="template-section">
                        <%- include('../partials/forms/template-daet') %>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalConfirmarDelete" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold">‚ö†Ô∏è Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div class="mb-3" style="font-size: 3rem;">üóëÔ∏è</div>
                    <p class="fs-5">Est√° a punto de eliminar el registro ID: <strong id="lblIdEliminar"></strong></p>
                    <p class="text-danger fw-bold">Esta acci√≥n es irreversible. ¬øEst√° seguro?</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger fw-bold" onclick="ejecutarEliminacion()">S√≠, Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNotificacion" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header text-white" id="headerNotificacion">
                    <h5 class="modal-title fw-bold" id="tituloNotificacion">Notificaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div id="iconoNotificacion" class="mb-3" style="font-size: 3.5rem;"></div>
                    <p id="mensajeNotificacion" class="fs-5 fw-medium"></p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="/js/mappings.js"></script>

    <script>
        // --- CONFIGURACI√ìN ---
        const API_URL = 'http://127.0.0.1:8081/api';
        
        // Variables de estado
        let resultadosActuales = []; 
        let idParaEliminar = null;
        let tipoActual = 'equipos';

        // --- 1. BUSCAR REGISTROS ---
        async function buscarRegistros() {
            tipoActual = document.getElementById('selTipo').value;
            const valor = document.getElementById('inputBusqueda').value.trim();
            const tbody = document.getElementById('tablaResultados');

            if (!valor) return mostrarNotificacion("Campo Vac√≠o", "Por favor ingrese un valor para buscar.", "info");

            // Definir URL seg√∫n tipo
            let url = '';
            if (tipoActual === 'equipos') url = `${API_URL}/buscarReciboEquipos/${valor}`;
            else if (tipoActual === 'perifericos') url = `${API_URL}/buscarReciboPerifericos/${valor}`;
            else if (tipoActual === 'daet') url = `${API_URL}/buscarEntregasAlDaet/${valor}`;

            tbody.innerHTML = '<tr><td colspan="6">Cargando resultados...</td></tr>';

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("No se encontraron registros.");
                
                // Normalizar respuesta (Array o Objeto √∫nico)
                const data = await res.json();
                resultadosActuales = Array.isArray(data) ? data : [data];

                if (resultadosActuales.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-danger">No se encontraron coincidencias.</td></tr>';
                    return;
                }

                renderizarTabla();

            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-muted">No se encontraron registros con ese criterio.</td></tr>';
                resultadosActuales = [];
            }
        }

        // --- 2. RENDERIZAR TABLA ---
        function renderizarTabla() {
            const tbody = document.getElementById('tablaResultados');
            tbody.innerHTML = '';

            resultadosActuales.forEach((item, index) => {
                const tr = document.createElement('tr');
                
                // Extraer datos comunes dependiendo del tipo
                let id, identificador, fecha, usuario, estatus;

                if (tipoActual === 'equipos') {
                    id = item.idEncabezado;
                    identificador = item.fmoEquipo;
                    fecha = item.fecha;
                    usuario = item.usuarioNombre;
                    estatus = item.estatus;
                } else if (tipoActual === 'perifericos') {
                    id = item.id; // O item.idEncabezado seg√∫n DTO
                    identificador = item.fmoSerial || "N/A";
                    fecha = item.fecha;
                    usuario = item.nombre; // En perifericos el usuario suele venir como 'nombre'
                    estatus = "N/A";
                } else if (tipoActual === 'daet') {
                    id = item.id;
                    identificador = item.solicitudDAET || item.fmoSerial;
                    fecha = item.fecha;
                    usuario = item.recibidoPor || "DAET";
                    estatus = item.estado;
                }

                tr.innerHTML = `
                    <td class="fw-bold">${index + 1}</td>
                    <td class="text-primary fw-bold">${identificador || 'S/D'}</td>
                    <td>${fecha || 'S/D'}</td>
                    <td>${usuario || 'S/D'}</td>
                    <td><span class="badge bg-secondary">${estatus || '-'}</span></td>
                    <td>
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-sm btn-info text-white" onclick="verRegistro(${index})" title="Ver Detalles">
                                üëÅÔ∏è Ver
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="confirmarEliminacion(${id})" title="Eliminar Registro">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 3. VER REGISTRO (MAPPING) ---
        function verRegistro(index) {
            const data = resultadosActuales[index];
            const modal = new bootstrap.Modal(document.getElementById('modalVerDetalle'));
            
            // Ocultar todos los templates primero
            document.querySelectorAll('.template-section').forEach(el => el.style.display = 'none');

            // Mostrar y llenar el correcto
            if (tipoActual === 'equipos') {
                const container = document.getElementById('view_equipos');
                container.style.display = 'block';
                // Usamos la funci√≥n importada de mappings.js
                mapearDatosEquipos(container, data);
            } 
            else if (tipoActual === 'perifericos') {
                const container = document.getElementById('view_perifericos');
                container.style.display = 'block';
                mapearDatosPerifericos(container, data);
            } 
            else if (tipoActual === 'daet') {
                const container = document.getElementById('view_daet');
                container.style.display = 'block';
                mapearDatosDaet(container, data);
            }

            modal.show();
        }

        // --- 4. PREPARAR ELIMINACI√ìN ---
        function confirmarEliminacion(id) {
            idParaEliminar = id;
            document.getElementById('lblIdEliminar').innerText = id;
            new bootstrap.Modal(document.getElementById('modalConfirmarDelete')).show();
        }

        // --- 5. EJECUTAR ELIMINACI√ìN (DELETE ENDPOINT) ---
        async function ejecutarEliminacion() {
            if (!idParaEliminar) return;

            let url = '';
            // Construir URL basada en el tipo seleccionado
            if (tipoActual === 'equipos') url = `${API_URL}/borrarReciboEquipo/${idParaEliminar}`;
            else if (tipoActual === 'perifericos') url = `${API_URL}/recibo-perifericos/${idParaEliminar}`;
            else if (tipoActual === 'daet') url = `${API_URL}/entregas-daet/${idParaEliminar}`;

            try {
                const res = await fetch(url, { method: 'DELETE' });

                // Cerrar modal confirmaci√≥n
                bootstrap.Modal.getInstance(document.getElementById('modalConfirmarDelete')).hide();

                if (res.ok) {
                    mostrarNotificacion("Eliminado", "El registro fue eliminado correctamente.", "exito");
                    // Limpiar tabla o recargar b√∫squeda
                    buscarRegistros(); 
                } else {
                    mostrarNotificacion("Error", "No se pudo eliminar el registro. Verifique dependencias.", "error");
                }
            } catch (error) {
                console.error(error);
                mostrarNotificacion("Error de Conexi√≥n", "No se pudo conectar con el servidor.", "error");
            } finally {
                idParaEliminar = null;
            }
        }

        // --- HELPER NOTIFICACIONES ---
        function mostrarNotificacion(titulo, mensaje, tipo) {
            const modalEl = document.getElementById('modalNotificacion');
            const header = document.getElementById('headerNotificacion');
            const tituloEl = document.getElementById('tituloNotificacion');
            const msgEl = document.getElementById('mensajeNotificacion');
            const iconoEl = document.getElementById('iconoNotificacion');

            tituloEl.innerText = titulo;
            msgEl.innerText = mensaje;
            header.className = 'modal-header text-white'; 
            
            if (tipo === 'exito') { header.classList.add('bg-success'); iconoEl.innerHTML = '‚úÖ'; }
            else if (tipo === 'error') { header.classList.add('bg-danger'); iconoEl.innerHTML = '‚ùå'; }
            else { header.classList.add('bg-primary'); iconoEl.innerHTML = '‚ÑπÔ∏è'; }

            new bootstrap.Modal(modalEl).show();
        }

        // --- LOGICA DE PLACEHOLDER DIN√ÅMICO ---
    const placeholderMap = {
        'equipos': "Inserte el fmoEquipo (Ej: 119...)",
        'perifericos': "Inserte el fmoAsignado (Ej: 119...)",
        'daet': "Inserte el fmoSerial"
    };

    function actualizarPlaceholder() {
        const tipo = document.getElementById('selTipo').value;
        const input = document.getElementById('inputBusqueda');
        
        // Asignar el texto seg√∫n el mapa, o un default por si acaso
        input.placeholder = placeholderMap[tipo] || "Ingrese el identificador...";
    }

    // Eventos para activar el cambio
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Asignar el evento 'change' al select
        document.getElementById('selTipo').addEventListener('change', actualizarPlaceholder);
        
        // 2. Ejecutar una vez al inicio para que arranque con el texto correcto
        actualizarPlaceholder();
        

    });
    </script>
</body>
</html>